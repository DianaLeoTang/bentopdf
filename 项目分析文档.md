# BentoPDF 项目分析文档

## 一、项目概述

**BentoPDF** 是一个强大的、以隐私为先的客户端PDF工具包，允许用户在浏览器中直接操作、编辑、合并和处理PDF文件。所有处理都在客户端完成，无需服务器端处理，确保文件安全性和隐私保护。

### 核心特性

- **隐私优先**：所有处理在浏览器中完成，文件永远不会上传到服务器
- **无限制**：可以处理任意数量的文件，无使用限制
- **高性能**：基于现代Web技术构建，快速高效
- **完全免费**：开源工具，对所有人免费

## 二、技术栈

### 构建工具

- **Vite**: 快速的前端构建工具
- **TypeScript**: 提供类型安全和更好的开发体验
- **Tailwind CSS**: 用于快速、一致的UI开发

### 核心依赖库

1. **PDF处理库**
   - `pdf-lib` (^1.17.1): 强大的客户端PDF操作库
   - `pdfjs-dist` (^5.4.296): Mozilla的PDF渲染引擎
   - `pdfkit` (^0.17.2): 用于创建和编辑PDF
   - `@neslinesli93/qpdf-wasm` (^0.3.0): qpdf的WebAssembly版本，用于PDF修复和转换

2. **图像处理**
   - `html2canvas` (^1.4.1): HTML转Canvas
   - `cropperjs` (^1.6.1): 图像裁剪
   - `tiff` (^7.1.2): TIFF格式支持
   - `utif` (^3.1.0): TIFF编码解码
   - `heic2any` (^0.0.4): HEIC格式转换

3. **OCR功能**
   - `tesseract.js` (^6.0.1): 光学字符识别

4. **其他工具**
   - `jspdf` (^3.0.3): PDF生成
   - `jszip` (^3.10.1): ZIP文件处理
   - `sortablejs` (^1.15.6): 拖放排序功能
   - `lucide` (^0.546.0): 图标库

### 开发工具

- **Vitest**: 单元测试框架
- **Prettier**: 代码格式化
- **Docker**: 容器化部署

## 三、项目结构

```text
bentopdf/
├── src/                          # 源代码目录
│   ├── js/                       # JavaScript/TypeScript代码
│   │   ├── main.ts              # 应用入口文件
│   │   ├── state.ts             # 全局状态管理
│   │   ├── ui.ts                # UI工具函数和模板
│   │   ├── canvasEditor.ts      # PDF编辑器
│   │   ├── mobileMenu.ts        # 移动端菜单
│   │   ├── config/              # 配置文件
│   │   │   ├── tools.ts         # 工具定义和分类
│   │   │   ├── pdf-tools.ts    # PDF工具配置
│   │   │   └── tesseract-languages.ts # OCR语言配置
│   │   ├── handlers/            # 事件处理器
│   │   │   ├── fileHandler.ts  # 文件处理逻辑
│   │   │   └── toolSelectionHandler.ts # 工具选择处理
│   │   ├── logic/               # 核心业务逻辑（PDF操作）
│   │   │   ├── index.ts        # 工具逻辑导出
│   │   │   ├── merge.ts        # PDF合并
│   │   │   ├── split.ts        # PDF分割
│   │   │   ├── compress.ts     # PDF压缩
│   │   │   ├── encrypt.ts      # PDF加密
│   │   │   ├── decrypt.ts      # PDF解密
│   │   │   ├── rotate.ts       # PDF旋转
│   │   │   ├── add-watermark.ts # 添加水印
│   │   │   └── ...             # 50+ 其他PDF工具
│   │   └── utils/               # 工具函数
│   │       └── helpers.ts      # 辅助函数
│   ├── css/                      # 样式文件
│   │   └── styles.css           # 主样式文件
│   └── tests/                    # 测试文件
├── public/                       # 静态资源
│   ├── images/                  # 图片资源
│   └── qpdf.wasm                # qpdf WebAssembly文件
├── index.html                   # 主页面
├── vite.config.ts               # Vite配置
├── tsconfig.json                # TypeScript配置
├── package.json                 # 项目依赖
└── Dockerfile                   # Docker构建文件
```

## 四、核心架构

### 1. 应用入口 (`main.ts`)

主入口文件负责：

- 初始化PDF.js Worker
- 处理Simple Mode（简化模式，隐藏品牌内容）
- 渲染工具网格界面
- 设置搜索功能（支持Ctrl/Cmd+K快捷键）
- 处理工具选择事件
- 初始化图标系统

```typescript
// 关键初始化代码
const init = () => {
  // 配置PDF.js Worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = new URL(
    'pdfjs-dist/build/pdf.worker.min.mjs',
    import.meta.url
  ).toString();

  // Simple Mode处理
  if (__SIMPLE_MODE__) {
    hideBrandingSections();
  }

  // 渲染工具网格
  categories.forEach((category) => {
    // 创建分类和工具卡片
  });

  // 设置搜索功能
  searchBar.addEventListener('input', () => {
    // 过滤工具
  });
};
```

### 2. 状态管理 (`state.ts`)

全局状态管理，存储当前应用状态：

```typescript
export const state = {
  activeTool: null,      // 当前激活的工具ID
  files: [],             // 当前处理的文件列表
  pdfDoc: null,          // 当前PDF文档对象
  pdfPages: [],          // PDF页面数组
  currentPdfUrl: null,   // 当前PDF的URL
};

// 重置状态
export function resetState() {
  state.activeTool = null;
  state.files = [];
  state.pdfDoc = null;
  state.pdfPages = [];
  state.currentPdfUrl = null;
  document.getElementById('tool-content').innerHTML = '';
}
```

### 3. 工具配置 (`config/tools.ts`)

定义了所有可用的PDF工具，按类别组织：

- **Popular Tools**: 热门工具（合并、分割、压缩等）
- **Edit & Annotate**: 编辑和注释工具
- **Convert to PDF**: 转换为PDF的工具
- **Convert from PDF**: 从PDF转换的工具
- **Organize & Manage**: 组织和管理工具
- **Optimize & Repair**: 优化和修复工具
- **Secure PDF**: PDF安全工具

每个工具包含：

- `id`: 工具唯一标识符
- `name`: 工具显示名称
- `icon`: Lucide图标名称
- `subtitle`: 工具描述

### 4. 工具逻辑系统 (`logic/index.ts`)

所有PDF操作工具的逻辑都集中在这里导出。每个工具可以包含：

- `process`: 处理函数（必需）
- `setup`: 初始化函数（可选）

```typescript
export const toolLogic = {
  merge: { process: merge, setup: setupMergeTool },
  split: { process: split, setup: setupSplitTool },
  encrypt,
  decrypt,
  // ... 50+ 其他工具
};
```

### 5. 工具选择处理器 (`handlers/toolSelectionHandler.ts`)

当用户选择工具时：

1. 设置当前激活的工具
2. 渲染工具界面模板
3. 初始化工具特定的UI（如果有setup函数）
4. 设置文件输入处理器
5. 绑定处理按钮事件

```typescript
export function setupToolInterface(toolId: any) {
  state.activeTool = toolId;
  dom.toolContent.innerHTML = toolTemplates[toolId]();
  createIcons({ icons });
  switchView('tool');

  // 设置处理逻辑
  if (toolLogic[toolId] && typeof toolLogic[toolId].setup === 'function') {
    toolLogic[toolId].setup();
  }

  // 设置文件输入
  if (fileInput) {
    setupFileInputHandler(toolId);
  }
}
```

## 五、核心功能实现

### 1. PDF合并 (`logic/merge.ts`)

支持两种模式：

- **文件模式**: 按文件顺序合并，可为每个文件指定页面范围
- **页面模式**: 可视化页面缩略图，拖拽排序合并

核心实现：

```typescript
export async function merge() {
  const newPdfDoc = await PDFLibDocument.create();

  if (mergeState.activeMode === 'file') {
    // 文件模式：按文件列表顺序合并
    for (const file of sortedFiles) {
      const pageIndices = parsePageRanges(rangeInputValue, totalPages);
      const copiedPages = await newPdfDoc.copyPages(sourcePdf, indicesToCopy);
      copiedPages.forEach((page) => newPdfDoc.addPage(page));
    }
  } else {
    // 页面模式：按缩略图顺序合并
    for (const el of pageElements) {
      const [copiedPage] = await newPdfDoc.copyPages(sourcePdf, [pageIndex]);
      newPdfDoc.addPage(copiedPage);
    }
  }

  const mergedPdfBytes = await newPdfDoc.save();
  downloadFile(new Blob([mergedPdfBytes], { type: 'application/pdf' }), 'merged.pdf');
}
```

### 2. 工具函数 (`utils/helpers.ts`)

提供通用辅助函数：

- **`initializeQpdf()`**: 初始化qpdf-wasm单例（用于PDF修复和转换）
- **`readFileAsArrayBuffer()`**: 读取文件为ArrayBuffer
- **`downloadFile()`**: 下载文件
- **`parsePageRanges()`**: 解析页面范围字符串（如"1-3,5,7-9"）
- **`formatBytes()`**: 格式化文件大小
- **`hexToRgb()`**: 十六进制颜色转RGB
- **`convertPoints()`**: PDF点单位转换

### 3. UI系统 (`ui.ts`)

提供统一的UI管理：

- DOM元素集中管理
- 加载器显示/隐藏
- 警告/提示对话框
- 视图切换（网格视图/工具视图）
- 工具模板系统

### 4. PDF工具分类 (`config/pdf-tools.ts`)

根据文件需求分类工具：

```typescript
// 单文件工具
export const singlePdfLoadTools = [
  'split', 'organize', 'rotate', 'compress', ...
];

// 简单工具（无需特殊处理）
export const simpleTools = [
  'encrypt', 'decrypt', 'change-permissions', ...
];

// 多文件工具
export const multiFileTools = [
  'merge', 'pdf-to-zip', 'jpg-to-pdf', ...
];
```

## 六、支持的PDF工具

### 组织和管理

- 合并PDF、分割PDF、组织页面、提取页面、删除页面
- 旋转PDF、N-Up PDF、查看PDF、交替合并、海报化PDF

### 编辑和修改

- PDF编辑器、添加页码、添加水印、页眉页脚
- 裁剪PDF、反转颜色、更改背景色、更改文本颜色
- 填充表单、扁平化PDF、删除注释、删除空白页

### 转换为PDF

- 图片转PDF（支持JPG、PNG、WebP、SVG、BMP、HEIC、TIFF）
- Markdown转PDF、文本转PDF

### 从PDF转换

- PDF转图片（JPG、PNG、WebP、BMP、TIFF）
- PDF转灰度、OCR PDF（使扫描PDF可搜索）

### 安全和优化

- 压缩PDF、修复PDF、加密PDF、解密PDF
- 更改权限、签名PDF、编辑内容、编辑元数据
- 删除元数据、线性化PDF、清理PDF

## 七、构建和部署

### 开发环境

```bash
npm install
npm run dev          # 开发服务器（端口5173）
```

### 生产构建

```bash
npm run build        # 构建生产版本
npm run preview      # 预览构建结果
```

### Docker部署

```bash
# 使用Docker Hub镜像
docker run -p 3000:8080 bentopdf/bentopdf:latest

# 使用Docker Compose
docker-compose up -d
```

### Simple Mode（简化模式）

用于企业内部部署，隐藏品牌内容：

```bash
SIMPLE_MODE=true npm run build
```

## 八、测试

项目使用Vitest进行单元测试：

```bash
npm test              # 运行测试
npm run test:ui       # 测试UI界面
npm run test:coverage # 测试覆盖率
```

测试文件位于 `src/tests/` 目录。

## 九、核心设计模式

1. **模块化设计**: 每个PDF工具都是独立的模块
2. **状态管理**: 集中式状态管理，易于重置和清理
3. **模板系统**: UI模板与逻辑分离
4. **工具注册**: 通过配置文件和工具逻辑对象统一管理
5. **异步处理**: 所有PDF操作都是异步的，使用Promise/async-await
6. **错误处理**: 统一的错误处理和用户提示

## 十、技术亮点

1. **完全客户端处理**: 利用WebAssembly和现代Web API实现浏览器端PDF处理
2. **隐私保护**: 文件不上传服务器，完全在本地处理
3. **高性能**: 使用Worker线程处理PDF操作，不阻塞主线程
4. **响应式设计**: 支持移动端和桌面端
5. **可扩展性**: 工具系统设计良好，易于添加新功能
6. **类型安全**: 使用TypeScript提供类型检查

## 十一、未来规划

根据README，计划中的功能：

- HTML转PDF
- 增强的Markdown转PDF支持
- 转换为PDF/A格式
- 直接编辑PDF内容
- PDF转Office（Word、Excel、PowerPoint）
- Office转PDF

## 十二、总结

BentoPDF是一个架构清晰、功能强大的客户端PDF处理工具。它采用现代化的技术栈，模块化的设计使得代码易于维护和扩展。核心优势在于完全客户端处理，保护用户隐私，同时提供丰富的PDF操作功能。项目结构合理，代码组织良好，是一个优秀的开源PDF工具项目。
